<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disco Elysium Dialogue Search App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        h2 {
            text-align: center;
            color: #ffffff;
        }
        label {
            font-weight: bold;
        }
        input, button {
            display: block;
            margin-bottom: 10px;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            background-color: #333;
            color: #e0e0e0;
        }
        input::placeholder {
            color: #aaa;
        }
        button {
            background-color: #6200ea;
            cursor: pointer;
            color: #ffffff;
            font-weight: bold;
        }
        button:hover {
            background-color: #3700b3;
        }
        #actor-list {
            border: 1px solid #333;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            width: calc(100% - 22px);
            background: #1e1e1e;
            z-index: 10;
            display: none;
            border-radius: 5px;
        }
        .actor-item {
            padding: 10px;
            cursor: pointer;
            color: #e0e0e0;
        }
        .actor-item:hover {
            background-color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #1e1e1e;
            border-radius: 5px;
        }
        th, td {
            border: 1px solid #333;
            padding: 10px;
            text-align: left;
            color: #e0e0e0;
        }
        th {
            background-color: #6200ea;
            color: #ffffff;
        }        tr:nth-child(even) {
            background-color: #222;
        }
        .button-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .button-row button {
            flex: 1;
            margin-bottom: 0;
        }
        .secondary-button {
            background-color: #424242 !important;
        }
        .secondary-button:hover {
            background-color: #616161 !important;
        }
        .actor-browser {
            display: none;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #1e1e1e;
        }
        .actor-browser-item {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .actor-browser-item:hover {
            background-color: #333;
        }
        .actor-browser-item:last-child {
            border-bottom: none;
        }
        .dialogue-count {
            color: #aaa;
            font-size: 12px;
            background-color: #333;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .no-dialogue {
            color: #666;
        }
        .dialogue-row {
            cursor: pointer;
        }
        .dialogue-row:hover {
            background-color: #2a2a2a !important;
        }
        .skill-check {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
            display: inline-block;
        }
        .skill-check.red {
            background-color: #d32f2f;
            color: white;
        }
        .skill-check.white {
            background-color: #f5f5f5;
            color: #333;
        }
        .connections-panel {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 5px;
            border-left: 4px solid #6200ea;
        }
        .connections-section {
            margin-bottom: 15px;
        }
        .connections-section h4 {
            margin: 0 0 8px 0;
            color: #6200ea;
            font-size: 14px;
        }
        .connection-item {
            padding: 8px;
            margin: 4px 0;
            background-color: #333;
            border-radius: 3px;
            font-size: 13px;
        }
        .connection-actor {
            font-weight: bold;
            color: #e0e0e0;
        }
        .alternate-condition {
            color: #aaa;
            font-style: italic;
            font-size: 11px;
        }
        .clickable-dialogue {
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .clickable-dialogue:hover {
            background-color: #444;
        }
        .breadcrumb {
            background-color: #1e1e1e;
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #aaa;
        }
        .breadcrumb-item {
            display: inline-block;
            margin-right: 5px;
        }
        .breadcrumb-separator {
            margin: 0 5px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Disco Elysium Dialogue Searcher</h2>

        <label for="actor-search">Search Actor:</label>
        <input type="text" id="actor-search" placeholder="Type to search actors" onkeyup="filterActors()">
        <div id="actor-list"></div>
        
        <label for="keyword">Dialogue Keyword:</label>
        <input type="text" id="keyword" placeholder="Enter keyword">
        
        <div class="button-row">
            <button onclick="searchDialogues()">Search</button>
            <button class="secondary-button" onclick="toggleActorBrowser()">List of Actors</button>
        </div>
        
        <div id="actor-browser" class="actor-browser">
            <div style="padding: 10px; border-bottom: 1px solid #333; font-weight: bold; background-color: #333;">
                All Actors (Loading...)
            </div>        </div>
          <div id="connections-panel" class="connections-panel">
            <h3 style="margin-top: 0; color: #6200ea;">Dialogue Connections</h3>
            <div style="margin-bottom: 10px;">                <button id="explore-tree-btn" onclick="exploreDialogueTree()" style="display: none; margin: 0; width: auto; padding: 5px 10px; font-size: 12px; background-color: #424242;">
                    Explore Full Tree
                </button>
            </div>
            <div id="connections-content">Select a dialogue to see connections...</div>
        </div>
        
        <table id="results">
            <thead>
                <tr>
                    <th>Actor</th>
                    <th>Dialogue</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <script>
        // Function to handle Enter key press on input fields
document.addEventListener("DOMContentLoaded", function() {
    const actorInput = document.getElementById('actor-search');
    const keywordInput = document.getElementById('keyword');
    const searchButton = document.querySelector('button');

    // Add event listener to both input fields
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            searchButton.click(); // Trigger the search button click
        }
    }

    actorInput.addEventListener('keypress', handleKeyPress);
    keywordInput.addEventListener('keypress', handleKeyPress);
});        let allActors = [];
        let allActorsWithCounts = [];
        let dialogueBreadcrumb = [];
        let currentDialogueContext = null; // Store current dialogue context
        let currentTreeData = null; // Store current tree data for expansion
        let currentTreeDepth = 6; // Track current depth for expansion

        async function fetchActors() {
            const response = await fetch('/get-actors');
            allActors = await response.json();
        }

        async function fetchAllActorsWithCounts() {
            try {
                const response = await fetch('/get-all-actors');
                allActorsWithCounts = await response.json();
                updateActorBrowserHeader();
            } catch (error) {
                console.error('Error fetching actors with counts:', error);
            }
        }

        function updateActorBrowserHeader() {
            const header = document.querySelector('#actor-browser > div');
            const totalActors = allActorsWithCounts.length;
            const actorsWithDialogue = allActorsWithCounts.filter(a => a.dialogue_count > 0).length;
            header.textContent = `All Actors (${totalActors} total, ${actorsWithDialogue} with dialogue)`;
        }

        function toggleActorBrowser() {
            const browser = document.getElementById('actor-browser');
            if (browser.style.display === 'none' || browser.style.display === '') {
                browser.style.display = 'block';
                populateActorBrowser();
            } else {
                browser.style.display = 'none';
            }
        }

        function populateActorBrowser() {
            const browser = document.getElementById('actor-browser');
            const existingItems = browser.querySelectorAll('.actor-browser-item');
            existingItems.forEach(item => item.remove());

            allActorsWithCounts.forEach(actorData => {
                const div = document.createElement('div');
                div.classList.add('actor-browser-item');
                if (actorData.dialogue_count === 0) {
                    div.classList.add('no-dialogue');
                }
                
                const actorName = document.createElement('span');
                actorName.textContent = actorData.actor;
                
                const count = document.createElement('span');
                count.classList.add('dialogue-count');
                count.textContent = actorData.dialogue_count === 0 ? 'No dialogue' : `${actorData.dialogue_count} lines`;
                
                div.appendChild(actorName);
                div.appendChild(count);
                
                if (actorData.dialogue_count > 0) {
                    div.onclick = () => selectActorFromBrowser(actorData.actor);
                }
                
                browser.appendChild(div);
            });
        }

        function selectActorFromBrowser(actor) {
            document.getElementById('actor-search').value = actor;
            document.getElementById('actor-list').style.display = 'none';
            document.getElementById('actor-browser').style.display = 'none';
            // Optionally trigger search immediately
            // searchDialogues();
        }

        function filterActors() {
            const input = document.getElementById('actor-search').value.toLowerCase();
            const list = document.getElementById('actor-list');
            list.innerHTML = '';

            if (input.length === 0) {
                list.style.display = 'none';
                return;
            }

            const filteredActors = allActors.filter(actor => actor.toLowerCase().includes(input));

            filteredActors.forEach(actor => {
                const div = document.createElement('div');
                div.classList.add('actor-item');
                div.textContent = actor;
                div.onclick = () => selectActor(actor);
                list.appendChild(div);
            });

            list.style.display = filteredActors.length > 0 ? 'block' : 'none';
        }

        function selectActor(actor) {
            document.getElementById('actor-search').value = actor;
            document.getElementById('actor-list').style.display = 'none';
        }

        async function searchDialogues() {
            const actor = document.getElementById('actor-search').value;
            const keyword = document.getElementById('keyword').value;
            
            // Properly encode URL parameters to handle special characters like commas and hash symbols
            const encodedActor = encodeURIComponent(actor);
            const encodedKeyword = encodeURIComponent(keyword);
            
            const response = await fetch(`/search-dialogues?actor=${encodedActor}&keyword=${encodedKeyword}`);
            const data = await response.json();
            const tbody = document.getElementById('results').querySelector('tbody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.classList.add('dialogue-row');
                
                // Add skill check indicators
                let indicators = '';
                if (row.hascheck) {
                    indicators += '<span class="skill-check white">CHECK</span>';
                }
                if (row.hasalts) {
                    indicators += '<span class="skill-check" style="background-color: #ff9800; color: white;">ALT</span>';
                }
                
                tr.innerHTML = `<td>${row.actor}</td><td>${row.dialogue}${indicators ? '<br>' + indicators : ''}</td>`;
                
                // Make row clickable to show connections
                tr.onclick = () => showDialogueConnections(row.conversationid, row.dialogueid, row.actor, row.dialogue);
                
                tbody.appendChild(tr);
            });
              // Hide connections panel when new search is performed
            document.getElementById('connections-panel').style.display = 'none';
            // Clear breadcrumb trail for new search
            dialogueBreadcrumb = [];
        }        async function showDialogueConnections(conversationId, dialogueId, actor, dialogue, fromBreadcrumb = false) {
            try {
                // Update breadcrumb trail unless we're navigating back
                if (!fromBreadcrumb) {
                    // Truncate dialogue text for breadcrumb display
                    const breadcrumbText = dialogue.length > 50 ? dialogue.substring(0, 50) + '...' : dialogue;
                    dialogueBreadcrumb.push({ 
                        conversationId, 
                        dialogueId, 
                        actor, 
                        dialogue: breadcrumbText,
                        fullDialogue: dialogue 
                    });
                    // Limit breadcrumb to 10 items to prevent it from getting too long
                    if (dialogueBreadcrumb.length > 10) {
                        dialogueBreadcrumb.shift();
                    }
                }

                currentDialogueContext = { conversationId, dialogueId, actor, dialogue };                const response = await fetch(`/get-dialogue-connections?conversationid=${conversationId}&dialogueid=${dialogueId}`);
                const data = await response.json();
                
                const panel = document.getElementById('connections-panel');
                const content = document.getElementById('connections-content');
                const exploreBtn = document.getElementById('explore-tree-btn');
                
                // Show the tree exploration button
                exploreBtn.style.display = 'inline-block';
                
                let html = '';
                  // Add breadcrumb navigation
                if (dialogueBreadcrumb.length > 1) {
                    html += '<div class="breadcrumb">';
                    html += '<strong>Navigation Path:</strong> ';
                    dialogueBreadcrumb.forEach((crumb, index) => {
                        if (index === dialogueBreadcrumb.length - 1) {
                            // Current dialogue - not clickable
                            html += `<span class="breadcrumb-item" style="color: #fff; font-weight: bold;">
                                ${crumb.actor}: ${crumb.dialogue}
                            </span>`;
                        } else {
                            // Previous dialogues - clickable
                            html += `<span class="breadcrumb-item">
                                <a href="#" onclick="navigateToBreadcrumb(${index})" style="color: #6200ea; text-decoration: none;">
                                    ${crumb.actor}: ${crumb.dialogue}
                                </a>
                            </span>`;
                            html += '<span class="breadcrumb-separator">→</span>';
                        }
                    });
                    html += '</div>';
                }
                
                html += `<div style="background-color: #1e1e1e; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>Selected:</strong> ${actor}<br>
                    <em>${dialogue.substring(0, 100)}${dialogue.length > 100 ? '...' : ''}</em>
                </div>`;
                  // Show skill checks with outcomes
                if (data.checks && data.checks.length > 0) {
                    html += '<div class="connections-section"><h4>Skill Checks</h4>';
                    data.checks.forEach(check => {
                        const checkType = check.isred ? 'red' : 'white';                        const checkClass = check.isred ? 'skill-check red' : 'skill-check white';
                        const difficultyDisplay = check.actual_difficulty ? 
                            `${check.actual_difficulty} (${check.difficulty_label})` : 
                            check.difficulty;
                        html += `<div class="connection-item">
                            <span class="${checkClass}">${check.skilltype}</span> - Difficulty ${difficultyDisplay}
                            ${check.flagname ? `<br><small>Flag: ${check.flagname}</small>` : ''}
                        </div>`;
                        
                        // Show skill check outcomes if available
                        if (data.skill_outcomes) {
                            const relatedOutcomes = data.skill_outcomes.filter(outcome => 
                                outcome.check_flag === check.flagname
                            );
                            
                            if (relatedOutcomes.length > 0) {
                                html += '<div style="margin-left: 15px; margin-top: 8px;">';
                                html += '<div style="font-size: 12px; color: #aaa; margin-bottom: 4px;">Possible Outcomes:</div>';
                                
                                const successOutcomes = relatedOutcomes.filter(o => o.outcome_type === 'SUCCESS');
                                const failureOutcomes = relatedOutcomes.filter(o => o.outcome_type === 'FAILURE');
                                
                                if (successOutcomes.length > 0) {
                                    html += '<div style="margin-bottom: 6px;">';
                                    html += '<span style="background-color: #4caf50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">SUCCESS</span>';
                                    successOutcomes.forEach(outcome => {
                                        html += `<div class="clickable-dialogue" onclick="navigateToDialogue(${outcome.conversationid}, ${outcome.dialogueid}, '${outcome.actor.replace(/'/g, "\\'")}', '${outcome.dialogue.replace(/'/g, "\\'")}')" style="margin-left: 10px; margin-top: 4px; font-size: 12px; color: #ccc;">
                                            <strong>${outcome.actor}:</strong> ${outcome.dialogue.substring(0, 80)}${outcome.dialogue.length > 80 ? '...' : ''} <span style="color: #888;">→</span>
                                        </div>`;
                                    });
                                    html += '</div>';
                                }
                                
                                if (failureOutcomes.length > 0) {
                                    html += '<div>';
                                    html += '<span style="background-color: #f44336; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">FAILURE</span>';
                                    failureOutcomes.forEach(outcome => {
                                        html += `<div class="clickable-dialogue" onclick="navigateToDialogue(${outcome.conversationid}, ${outcome.dialogueid}, '${outcome.actor.replace(/'/g, "\\'")}', '${outcome.dialogue.replace(/'/g, "\\'")}')" style="margin-left: 10px; margin-top: 4px; font-size: 12px; color: #ccc;">
                                            <strong>${outcome.actor}:</strong> ${outcome.dialogue.substring(0, 80)}${outcome.dialogue.length > 80 ? '...' : ''} <span style="color: #888;">→</span>
                                        </div>`;
                                    });
                                    html += '</div>';
                                }
                                
                                html += '</div>';
                            }
                        }
                    });
                    html += '</div>';
                }
                
                // Show alternates
                if (data.alternates && data.alternates.length > 0) {
                    html += '<div class="connections-section"><h4>Alternate Text</h4>';
                    data.alternates.forEach(alt => {
                        html += `<div class="connection-item">
                            <div class="alternate-condition">Condition: ${alt.condition}</div>
                            <div>"${alt.alternateline}"</div>
                        </div>`;
                    });
                    html += '</div>';
                }
                  // Show connected dialogues (filter out empty/system entries)
                if (data.connected && data.connected.length > 0) {
                    const meaningfulConnections = data.connected.filter(conn => 
                        conn.dialogue.trim() !== '0' && 
                        conn.dialogue.trim() !== '' && 
                        conn.dialogue.length > 3
                    );
                    
                    // Also show system connectors that might be part of skill check flow
                    const systemConnectors = data.connected.filter(conn => 
                        conn.dialogue.trim() === '0' && 
                        conn.condition && 
                        conn.condition.length > 0
                    );
                    
                    if (meaningfulConnections.length > 0) {
                        html += '<div class="connections-section"><h4>What Happens Next</h4>';
                        meaningfulConnections.forEach((conn, index) => {
                            const connectorType = conn.isconnector ? 'AUTO' : 'CHOICE';
                            const checkIndicator = conn.hascheck ? ' 🎲' : '';
                            let conditionInfo = '';
                            if (conn.condition && conn.condition.length > 0 && conn.condition !== 'null') {
                                conditionInfo = `<div style="font-size: 10px; color: #888; margin-top: 2px;">Condition: ${conn.condition.substring(0, 80)}${conn.condition.length > 80 ? '...' : ''}</div>`;
                            }
                            html += `<div class="connection-item clickable-dialogue" onclick="navigateToDialogue(${conn.destinationconversationid}, ${conn.destinationdialogueid}, '${conn.actor.replace(/'/g, "\\'")}', '${conn.dialogue.replace(/'/g, "\\'").substring(0, 200)}')">
                                <div class="connection-actor">[${connectorType}] ${conn.actor}${checkIndicator}</div>
                                <div>${conn.dialogue.substring(0, 120)}${conn.dialogue.length > 120 ? '...' : ''}</div>
                                ${conditionInfo}
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">Click to continue →</div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                    
                    // Show system connectors for debugging
                    if (systemConnectors.length > 0) {
                        html += '<div class="connections-section"><h4>System Connectors (Debug)</h4>';
                        systemConnectors.forEach((conn, index) => {
                            html += `<div class="connection-item" style="background-color: #2a2a2a; border-left: 3px solid #ff9800;">
                                <div style="font-size: 11px; color: #ff9800; font-weight: bold;">SYSTEM CONNECTOR</div>
                                <div style="font-size: 12px; color: #ccc;">Actor: ${conn.actor}</div>
                                <div style="font-size: 11px; color: #aaa; margin-top: 4px;">Condition: ${conn.condition}</div>
                                <div style="font-size: 10px; color: #666; margin-top: 2px;">Destination: ${conn.destinationconversationid}:${conn.destinationdialogueid}</div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                }
                  if (!data.checks.length && !data.alternates.length && !data.skill_outcomes.length && (!data.connected.length || !data.connected.filter(conn => conn.dialogue.trim() !== '0' && conn.dialogue.trim() !== '' && conn.dialogue.length > 3).length)) {
                    html += '<div style="color: #aaa; font-style: italic;">No connections, skill checks, or alternates found for this dialogue.</div>';
                }
                
                content.innerHTML = html;
                panel.style.display = 'block';
                panel.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error fetching dialogue connections:', error);
            }
        }

        function navigateToDialogue(conversationId, dialogueId, actor, dialogue) {
            showDialogueConnections(conversationId, dialogueId, actor, dialogue);
        }        function navigateToBreadcrumb(index) {
            // Trim breadcrumb to the selected point + 1 (include the clicked item)
            dialogueBreadcrumb = dialogueBreadcrumb.slice(0, index + 1);
            const crumb = dialogueBreadcrumb[index];
            
            // Show the connections for the selected breadcrumb item
            showDialogueConnections(crumb.conversationId, crumb.dialogueId, crumb.actor, crumb.fullDialogue || crumb.dialogue, true);
        }        
        
        async function exploreDialogueTree(depthChange = 0) {
            if (!currentDialogueContext) {
                alert('No dialogue selected for tree exploration');
                return;
            }
            
            try {
                // Adjust depth based on the parameter
                if (depthChange > 0) {
                    currentTreeDepth += depthChange;
                } else if (depthChange < 0) {
                    currentTreeDepth = Math.max(3, currentTreeDepth + depthChange); // Minimum depth of 3
                } else {
                    currentTreeDepth = 6; // Reset to default depth
                }
                
                const response = await fetch(`/explore-dialogue-tree?conversationid=${currentDialogueContext.conversationId}&dialogueid=${currentDialogueContext.dialogueId}&depth=${currentTreeDepth}`);
                const tree = await response.json();
                
                // Store tree data for potential expansion
                currentTreeData = tree;
                
                // Display tree in a modal or expanded view
                showDialogueTreeModal(tree);
            } catch (error) {
                console.error('Error exploring dialogue tree:', error);
                alert('Error exploring dialogue tree');
            }
        }        function showDialogueTreeModal(tree) {
            // Remove existing modal if present
            const existingModal = document.querySelector('.dialogue-tree-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'dialogue-tree-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #1e1e1e; border-radius: 10px; padding: 20px; 
                max-width: 95%; max-height: 95%; overflow-y: auto;
                border: 2px solid #6200ea; min-width: 800px;
            `;
            
            modalContent.innerHTML = `
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #6200ea;">Dialogue Tree Explorer (Depth: ${currentTreeDepth})</h3>
                    <div>
                        <button onclick="exploreDialogueTree(-3)" style="
                            background: #ff5722; color: white; border: none; padding: 8px 16px; 
                            border-radius: 5px; cursor: pointer; margin-right: 10px;
                            font-size: 12px; ${currentTreeDepth <= 3 ? 'opacity: 0.5; cursor: not-allowed;' : ''}
                        " ${currentTreeDepth <= 3 ? 'disabled' : ''}>Reduce Depth (-3)</button>
                        <button onclick="exploreDialogueTree(3)" style="
                            background: #6200ea; color: white; border: none; padding: 8px 16px; 
                            border-radius: 5px; cursor: pointer; margin-right: 10px;
                            font-size: 12px;
                        ">Expand Depth (+3)</button>
                        <button onclick="document.querySelector('.dialogue-tree-modal').remove()" style="
                            background: #424242; color: white; border: none; padding: 8px 16px; 
                            border-radius: 5px; cursor: pointer; font-size: 12px;
                        ">Close</button>
                    </div>
                </div>
                <div id="tree-content">${renderTreeNode(tree, 0)}</div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }        
        
        function renderTreeNode(node, depth, accumulatedConditions = []) {
            if (!node) return '';
            
            const indent = '　'.repeat(depth); // Use full-width space for indentation
            const isSystemConnector = node.dialogue === '0';
            const hasSkillCheck = node.skill_check;
            
            // Collect this node's condition if it exists
            const currentConditions = [...accumulatedConditions];
            if (node.condition && node.condition.trim() !== '' && node.condition !== 'null') {
                currentConditions.push(node.condition);
            }
            
            // More aggressive system connector filtering
            if (isSystemConnector && !hasSkillCheck) {
                // If this system connector has only one child, try to collapse it
                if (node.children && node.children.length === 1) {
                    const child = node.children[0];
                    const childIsSystemConnector = child.dialogue === '0';
                    
                    // If the child is also a system connector, continue accumulating
                    if (childIsSystemConnector) {
                        return renderTreeNode(child, depth, currentConditions);
                    }
                    
                    // If the child is actual dialogue, render it with accumulated conditions
                    return renderTreeNode(child, depth, currentConditions);
                }
                
                // If this system connector has multiple children but no skill check,
                // we still want to show it as a branching point, but only if conditions are meaningful
                if (node.children && node.children.length > 1) {
                    const hasSignificantCondition = currentConditions.some(cond => 
                        cond.length > 15 || 
                        cond.includes('>=') || 
                        cond.includes('<=') || 
                        cond.includes('==') ||
                        cond.includes('!=') ||
                        cond.includes('failed') ||
                        cond.includes('passed')
                    );
                    
                    // If no significant conditions and multiple children are all system connectors,
                    // render children directly with current accumulated conditions
                    if (!hasSignificantCondition && 
                        node.children.every(child => child.dialogue === '0')) {
                        let html = '';
                        node.children.forEach(child => {
                            html += renderTreeNode(child, depth, currentConditions);
                        });
                        return html;
                    }
                }
            }            
            let html = `<div style="margin: 8px 0; padding: 8px; background: ${isSystemConnector ? '#2a2a2a' : '#333'}; border-radius: 5px; border-left: 3px solid ${hasSkillCheck ? '#ff5722' : '#6200ea'};">`;
            
            html += `<div style="font-size: 12px; color: #aaa; word-wrap: break-word; white-space: pre-wrap;">${indent}${depth > 0 ? '└─ ' : ''}`;
            
            if (isSystemConnector) {
                html += `<span style="color: #ff9800; font-weight: bold;">[SYSTEM CONNECTOR]</span>`;
                
                // Show accumulated conditions
                if (currentConditions.length > 0) {
                    html += `<br>${indent}   Conditions:`;
                    currentConditions.forEach((condition, index) => {
                        html += `<br>${indent}     ${index + 1}. <span style="color: #ccc; font-family: monospace; font-size: 11px; word-wrap: break-word;">${condition}</span>`;
                    });
                }
            } else {
                html += `<span style="color: #e0e0e0; font-weight: bold;">${node.actor}:</span> `;
                // Show full dialogue with proper wrapping
                html += `<span style="color: #ccc; word-wrap: break-word; white-space: pre-wrap; display: inline-block; max-width: 100%;">${node.dialogue}</span>`;
                
                // Show accumulated conditions from collapsed system connectors
                if (currentConditions.length > 0) {
                    html += `<br>${indent}   <span style="color: #888; font-size: 10px; word-wrap: break-word; white-space: pre-wrap;">Required: ${currentConditions.join(' AND ')}</span>`;
                }
                
                if (hasSkillCheck) {
                    const check = node.skill_check;
                    const checkClass = check.isred ? 'background: #f44336;' : 'background: #fff; color: #333;';
                    const difficultyDisplay = check.actual_difficulty ? 
                        `${check.skilltype} ${check.actual_difficulty} (${check.difficulty_label})` : 
                        `${check.skilltype} ${check.difficulty}`;
                    html += `<br>${indent}   <span style="${checkClass} padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-top: 4px; display: inline-block;">${difficultyDisplay}</span>`;
                }
                
                // Show this node's specific condition (if not already in accumulated conditions)
                if (node.condition && node.condition !== 'null' && !currentConditions.includes(node.condition)) {
                    html += `<br>${indent}   <span style="color: #888; font-size: 10px; word-wrap: break-word; white-space: pre-wrap;">Condition: ${node.condition}</span>`;
                }
            }
            
            html += '</div>';
            
            // Render children
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    html += renderTreeNode(child, depth + 1, []);
                });
            }
            
            html += '</div>';
            return html;
        }

        fetchActors();
        fetchAllActorsWithCounts();
    </script>
</body>
</html>
